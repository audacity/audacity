set(TARGET twolame)
add_library(${TARGET} STATIC)

set(TARGET_ROOT ${AUDACITY_ROOT}/lib-src/twolame)

list(APPEND SOURCES
   PRIVATE
      ${TARGET_ROOT}/libtwolame/ath.c
      ${TARGET_ROOT}/libtwolame/availbits.c
      ${TARGET_ROOT}/libtwolame/bitbuffer.c
      ${TARGET_ROOT}/libtwolame/crc.c
      ${TARGET_ROOT}/libtwolame/dab.c
      ${TARGET_ROOT}/libtwolame/encode.c
      ${TARGET_ROOT}/libtwolame/energy.c
      ${TARGET_ROOT}/libtwolame/fft.c
      ${TARGET_ROOT}/libtwolame/get_set.c
      ${TARGET_ROOT}/libtwolame/mem.c
      ${TARGET_ROOT}/libtwolame/psycho_0.c
      ${TARGET_ROOT}/libtwolame/psycho_1.c
      ${TARGET_ROOT}/libtwolame/psycho_2.c
      ${TARGET_ROOT}/libtwolame/psycho_3.c
      ${TARGET_ROOT}/libtwolame/psycho_4.c
      ${TARGET_ROOT}/libtwolame/psycho_n1.c
      ${TARGET_ROOT}/libtwolame/subband.c
      ${TARGET_ROOT}/libtwolame/twolame.c
      ${TARGET_ROOT}/libtwolame/util.c
)

list(APPEND OPTIONS
   PRIVATE
      $<$<C_COMPILER_ID:AppleClang,Clang,GNU>:
         -Wno-unused-parameter
         -Wno-unused-variable
         -Wno-unused-function
      >
      $<$<C_COMPILER_ID:MSVC>:
         /wd4100
         /wd4505
      >
)

list(APPEND PROPERTIES
   POSITION_INDEPENDENT_CODE On
)

include(CheckIncludeFile)
include(CheckTypeSize)
include(TestBigEndian)
include(CheckLibraryExists)

# Check for headers
check_include_file(assert.h   HAVE_ASSERT_H)
check_include_file(unistd.h   HAVE_UNISTD_H)
check_include_file(inttypes.h HAVE_INTTYPES_H)
check_include_file(malloc.h   HAVE_MALLOC_H)
check_include_file(getopt.h   HAVE_GETOPT_H)

check_include_file(stdlib.h   HAVE_STDLIB_H)
check_include_file(string.h   HAVE_STRING_H)

check_type_size("short" SIZEOF_SHORT)
check_type_size("float" SIZEOF_FLOAT)

if(NOT SIZEOF_SHORT EQUAL 2)
   message(FATAL_ERROR "twolame: sizeof(short)=${SIZEOF_SHORT}, expected 2 (16-bit short).")
endif()
if(NOT SIZEOF_FLOAT EQUAL 4)
   message(FATAL_ERROR "twolame: sizeof(float)=${SIZEOF_FLOAT}, expected 4 (32-bit float).")
endif()

test_big_endian(WORDS_BIGENDIAN)

check_library_exists(m  sqrt   "" HAVE_LIBM_SQRT)
check_library_exists(m  lrintf "" HAVE_LIBM_LRINTF)
check_library_exists(mx powf   "" HAVE_LIBMX)

unset(HAVE_LIBM)
if(HAVE_LIBM_SQRT AND HAVE_LIBM_LRINTF)
   set(HAVE_LIBM 1)
endif()

set(CONFIG_IN ${CMAKE_CURRENT_BINARY_DIR}/config.h.in)
file(WRITE ${CONFIG_IN} "/* Generated by CMake: twolame config */\n#pragma once\n\n"
"#cmakedefine HAVE_ASSERT_H 1\n"
"#cmakedefine HAVE_UNISTD_H 1\n"
"#cmakedefine HAVE_INTTYPES_H 1\n"
"#cmakedefine HAVE_MALLOC_H 1\n"
"#cmakedefine HAVE_GETOPT_H 1\n"
"#cmakedefine HAVE_STDLIB_H 1\n"
"#cmakedefine HAVE_STRING_H 1\n"
"\n"
"#cmakedefine HAVE_LIBM 1\n"
"#cmakedefine HAVE_LIBMX 1\n"
"\n"
"#cmakedefine WORDS_BIGENDIAN 1\n"
"\n"
"#define SIZEOF_SHORT @SIZEOF_SHORT@\n"
"#define SIZEOF_FLOAT @SIZEOF_FLOAT@\n"
"\n"
"#define PACKAGE \"twolame\"\n"
"#define PACKAGE_VERSION \"0.3.13\"\n"
"#define PACKAGE_BUGREPORT \"twolame-discuss@lists.sourceforge.net\"\n"
"\n"
"/* inline handling (match win32/configwin.h intent) */\n"
"#undef inline\n"
"#if defined(_MSC_VER)\n"
"#  define inline __inline\n"
"#endif\n"
)

configure_file(${CONFIG_IN} ${CMAKE_CURRENT_BINARY_DIR}/private/config.h @ONLY)

target_include_directories(${TARGET}
   PUBLIC
      ${TARGET_ROOT}/libtwolame
   PRIVATE
      ${CMAKE_CURRENT_BINARY_DIR}/private
)

if(HAVE_LIBM)
   target_link_libraries(${TARGET} PRIVATE m)
endif()
if(HAVE_LIBMX)
   target_link_libraries(${TARGET} PRIVATE mx)
endif()

target_sources(${TARGET} PRIVATE ${SOURCES})
target_compile_options(${TARGET} PRIVATE ${OPTIONS})

target_compile_options(${TARGET} PRIVATE
  $<$<COMPILE_LANGUAGE:C>:
    $<$<C_COMPILER_ID:AppleClang,Clang,GNU>:-include;${CMAKE_CURRENT_BINARY_DIR}/private/config.h>
    $<$<C_COMPILER_ID:MSVC>:/FI${CMAKE_CURRENT_BINARY_DIR}/private/config.h>
  >
)

set_target_properties(${TARGET} PROPERTIES ${PROPERTIES})

set_property(TARGET ${TARGET} PROPERTY C_STANDARD 99)
set_property(TARGET ${TARGET} PROPERTY C_STANDARD_REQUIRED ON)

option(TWOLAME_BUILD_FRONTEND "Build twolame CLI (requires libsndfile + getopt.h)" OFF)

if(TWOLAME_BUILD_FRONTEND)
   set(HAVE_SNDFILE FALSE)

   find_package(PkgConfig QUIET)
   if(PkgConfig_FOUND)
      pkg_check_modules(SNDFILE QUIET sndfile>=1.0.0)
      if(SNDFILE_FOUND)
         set(HAVE_SNDFILE TRUE)
      endif()
   endif()

   if(NOT HAVE_SNDFILE)
      find_path(SNDFILE_INCLUDE_DIR sndfile.h)
      find_library(SNDFILE_LIBRARY NAMES sndfile)
      if(SNDFILE_INCLUDE_DIR AND SNDFILE_LIBRARY)
         set(HAVE_SNDFILE TRUE)
      endif()
   endif()

   if(HAVE_SNDFILE AND HAVE_GETOPT_H)
      add_executable(twolame_frontend
         ${TARGET_ROOT}/frontend/frontend.c
         ${TARGET_ROOT}/frontend/frontend.h
         ${TARGET_ROOT}/frontend/audioin_raw.c
         ${TARGET_ROOT}/frontend/audioin_sndfile.c
      )
      set_target_properties(twolame_frontend PROPERTIES OUTPUT_NAME twolame)
      target_link_libraries(twolame_frontend PRIVATE ${TARGET})

      target_include_directories(twolame_frontend PRIVATE
         ${TARGET_ROOT}/libtwolame
      )

      if(SNDFILE_FOUND)
         target_include_directories(twolame_frontend PRIVATE ${SNDFILE_INCLUDE_DIRS})
         target_compile_options(twolame_frontend PRIVATE ${SNDFILE_CFLAGS_OTHER})
         target_link_libraries(twolame_frontend PRIVATE ${SNDFILE_LIBRARIES})
         target_link_directories(twolame_frontend PRIVATE ${SNDFILE_LIBRARY_DIRS})
      else()
         target_include_directories(twolame_frontend PRIVATE ${SNDFILE_INCLUDE_DIR})
         target_link_libraries(twolame_frontend PRIVATE ${SNDFILE_LIBRARY})
      endif()
   else()
      message(STATUS "twolame: frontend not built (libsndfile=${HAVE_SNDFILE}, getopt.h=${HAVE_GETOPT_H})")
   endif()
endif()

option(TWOLAME_BUILD_SIMPLEFRONTEND "Build stwolame sample app" OFF)
if(TWOLAME_BUILD_SIMPLEFRONTEND)
   add_executable(stwolame
      ${TARGET_ROOT}/simplefrontend/simplefrontend.c
      ${TARGET_ROOT}/simplefrontend/audio_wave.c
      ${TARGET_ROOT}/simplefrontend/audio_wave.h
   )
   target_link_libraries(stwolame PRIVATE ${TARGET})
   target_include_directories(stwolame PRIVATE ${TARGET_ROOT}/libtwolame)
endif()
